# PR Reviewer Assignment Service

Микросервис для автоматического назначения ревьюеров на Pull Request'ы внутри команд.

## Описание

Сервис позволяет:
- Создавать команды и управлять участниками
- Автоматически назначать до 2 ревьюверов из команды автора при создании PR
- Переназначать ревьюверов (до merge PR)
- Получать список PR'ов, назначенных конкретному пользователю
- Управлять активностью пользователей
- Массово деактивировать пользователей команды с безопасным переназначением ревьюверов

## Технологический стек

- **Python 3.11**
- **FastAPI** - веб-фреймворк
- **SQLAlchemy** (async) - ORM
- **PostgreSQL** - база данных
- **Pydantic** - валидация данных

## Быстрый старт

### Требования

- Docker и Docker Compose

### Запуск

```bash
docker-compose up
```

## Тестирование

### Интеграционные/E2E тесты

Запуск тестов:

```bash
# Установите зависимости
pip install -r requirements.txt

# Запустите тесты
pytest tests/ -v

# С покрытием кода
pytest tests/ --cov=. --cov-report=html
```

Тесты покрывают:
- Создание и получение команд
- Создание PR с автоматическим назначением ревьюверов
- Merge PR (включая идемпотентность)
- Переназначение ревьюверов
- Деактивация пользователей
- Получение PR'ов пользователя
- Массовая деактивация команды
- Обработку ошибок

### Нагрузочное тестирование

Для запуска нагрузочного тестирования:

```bash
# Убедитесь, что сервис запущен
docker-compose up -d

# Запустите Locust
locust -f locustfile.py --headless --users 5 --spawn-rate 1 --run-time 60s --host http://localhost:8080 --html load_test_report.html
```

Или используйте веб-интерфейс:

```bash
locust -f locustfile.py --host http://localhost:8080
```

Затем откройте http://localhost:8089 в браузере.

Подробные результаты и инструкции см. в [LOAD_TEST_RESULTS.md](LOAD_TEST_RESULTS.md)

## Особенности реализации

### Принятые решения

1. **Строковые ID**: API использует строковые идентификаторы (например, "u1", "pr-1001"), которые хранятся в базе данных как уникальные поля. Внутренние числовые ID используются для связей между таблицами.

2. **Автоматическое создание таблиц**: При запуске приложения таблицы создаются автоматически через SQLAlchemy `create_all()`. Миграции не требуются для данного объема данных.

3. **Идемпотентность merge**: Операция merge является идемпотентной - повторный вызов не приводит к ошибке и возвращает актуальное состояние PR.

4. **Валидация бизнес-правил**:
   - Неактивные пользователи (`isActive=false`) не назначаются на ревью
   - После `MERGED` нельзя менять список ревьюверов
   - При переназначении новый ревьювер должен быть из команды заменяемого ревьювера
   - Автор PR не может быть назначен ревьювером своего PR

5. **Оптимизация производительности**:
   - Batch операции для массовых обновлений
   - Индексы на часто используемых полях
   - Минимизация количества запросов к БД
   - Асинхронная обработка запросов

Переменные окружения:
- `DATABASE_URL` - URL подключения к PostgreSQL (по умолчанию настраивается через docker-compose)
- `TEST_DATABASE_URL` - URL тестовой БД (для тестов)

## Разработка

### Локальная разработка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Создайте файл `.env`:
```
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/pr_reviewer_db
TEST_DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/pr_reviewer_test
```

3. Запустите PostgreSQL локально или через docker-compose

4. Запустите приложение:
```bash
python main.py
```
