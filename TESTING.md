# Инструкция по тестированию

## Интеграционные/E2E тесты

### Подготовка

1. Убедитесь, что PostgreSQL запущен:
```bash
docker-compose up -d db
```

2. Создайте тестовую базу данных:
```bash
docker-compose exec db psql -U postgres -c "CREATE DATABASE pr_reviewer_test;"
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

### Запуск тестов

```bash
# Все тесты
pytest tests/ -v

# С покрытием кода
pytest tests/ --cov=. --cov-report=html --cov-report=term

# Конкретный тест
pytest tests/test_e2e.py::test_team_lifecycle -v
```

### Покрытие тестами

Тесты покрывают следующие сценарии:

1. ✅ Создание и получение команд
2. ✅ Создание PR с автоматическим назначением ревьюверов
3. ✅ Merge PR (включая проверку идемпотентности)
4. ✅ Переназначение ревьюверов
5. ✅ Деактивация пользователей
6. ✅ Получение PR'ов пользователя
7. ✅ Массовая деактивация команды
8. ✅ Обработка ошибок (404, 409, 400)

## Нагрузочное тестирование

### Запуск через командную строку

```bash
# Убедитесь, что сервис запущен
docker-compose up -d

# Запустите тест на 60 секунд с 5 пользователями
locust -f locustfile.py \
    --headless \
    --users 5 \
    --spawn-rate 1 \
    --run-time 60s \
    --host http://localhost:8080 \
    --html load_test_report.html \
    --csv load_test_results
```

### Запуск через веб-интерфейс

```bash
locust -f locustfile.py --host http://localhost:8080
```

Затем откройте http://localhost:8089 в браузере и настройте параметры тестирования.

### Параметры тестирования

- **Users**: 5 (соответствует RPS ~5)
- **Spawn rate**: 1 пользователь/сек
- **Run time**: 60 секунд (или больше для более точных результатов)

### Анализ результатов

После завершения теста результаты будут сохранены в:
- `load_test_report.html` - интерактивный HTML отчет
- `load_test_results_stats.csv` - статистика по эндпоинтам
- `load_test_results_failures.csv` - список ошибок

### Ключевые метрики

Обратите внимание на:
- **Median response time** - должно быть < 100 мс
- **95th percentile** - должно быть < 200 мс
- **99th percentile** - должно быть < 300 мс
- **Failure rate** - должно быть < 0.1%
- **Requests per second** - должно быть ~5

## Пример результатов

### Ожидаемые показатели при средних объемах данных:

```
Type     Name                          # reqs      # fails  Avg     Min     Max     Median  req/s
--------|----------------------------|----------|-------|-------|-------|-------|-------|------
GET      /team/get                     150        0       45      12      120     42      2.5
GET      /users/getReview              100        0       38      10      95      35      1.7
POST     /pullRequest/create           100        0       52      15      130     48      1.7
POST     /pullRequest/merge             50         0       35      12      80      32      0.8
POST     /users/setIsActive             50         0       28      10      65      25      0.8
--------|----------------------------|----------|-------|-------|-------|-------|-------|------
         Aggregated                    450        0       42      10      130     40      7.5
```

### Статистика по времени ответа:

- **Median (50th percentile)**: ~40 мс
- **95th percentile**: ~120 мс
- **99th percentile**: ~200 мс
- **Max**: ~130 мс

Все показатели укладываются в требуемые SLI (300 мс для 99-го перцентиля).

## Устранение проблем

### Тесты не запускаются

1. Проверьте, что PostgreSQL запущен
2. Убедитесь, что тестовая БД создана
3. Проверьте переменные окружения `TEST_DATABASE_URL`

### Locust не запускается

1. Убедитесь, что сервис доступен на http://localhost:8080
2. Проверьте, что все зависимости установлены: `pip install locust`
3. Проверьте формат locustfile.py

### Высокое время ответа

1. Проверьте, что БД не перегружена
2. Убедитесь, что индексы созданы
3. Проверьте логи приложения на наличие ошибок

